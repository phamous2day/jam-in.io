"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(exports,"__esModule",{value:!0});var _getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_=require("./"),_2=_interopRequireDefault(_),_toHost=require("./to-host"),_toHost2=_interopRequireDefault(_toHost),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_isZeitWorld=require("./is-zeit-world"),_isZeitWorld2=_interopRequireDefault(_isZeitWorld),_domainRegex2=require("domain-regex"),_domainRegex3=_interopRequireDefault(_domainRegex2),_errors=require("./errors"),_dns=require("./dns"),domainRegex=(0,_domainRegex3["default"])(),Alias=function(e){function r(){return(0,_classCallCheck3["default"])(this,r),(0,_possibleConstructorReturn3["default"])(this,(0,_getPrototypeOf2["default"])(r).apply(this,arguments))}return(0,_inherits3["default"])(r,e),(0,_createClass3["default"])(r,[{key:"ls",value:function(){function e(e){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e){var r,n;return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!e){t.next=11;break}return t.next=3,this.findDeployment(e);case 3:if(r=t.sent){t.next=8;break}throw n=new Error('Aliases not found by "'+e+'". Run '+_chalk2["default"].dim("`now alias ls`")+" to see your aliases."),n.userError=!0,n;case 8:return t.abrupt("return",this.listAliases(r.uid));case 11:return t.abrupt("return",this.listAliases());case 12:case"end":return t.stop()}},t,this)}));return e}()},{key:"rm",value:function(){function e(e){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e){var r=this;return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.retry(function(){var t=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function n(t,a){var o,s;return _regenerator2["default"].wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,r._fetch("/now/aliases/"+e.uid,{method:"DELETE"});case 2:if(o=n.sent,403!==o.status){n.next=5;break}return n.abrupt("return",t(new Error("Unauthorized")));case 5:if(200===o.status){n.next=8;break}throw s=new Error("Deletion failed. Try again later.");case 8:case"end":return n.stop()}},n,r)}));return function(e,r){return t.apply(this,arguments)}}()));case 1:case"end":return t.stop()}},t,this)}));return e}()},{key:"findDeployment",value:function(){function e(e){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e){var r,n,a,o,s=this;return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.list();case 2:return r=t.sent,n=void 0,a=void 0,/\./.test(e)?(a=(0,_toHost2["default"])(e),n="url"):(a=e,n="uid"),o=r.find(function(e){return e[n]===a?(s._debug&&console.log("> [debug] matched deployment "+e.uid+" by "+n+" "+a),!0):a+".now.sh"===e.url?(s._debug&&console.log("> [debug] matched deployment "+e.uid+" by url "+e.url),!0):!1}),t.abrupt("return",o);case 7:case"end":return t.stop()}},t,this)}));return e}()},{key:"set",value:function(){function e(e,t){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e,r){var n,a,o,s,u,i,l,c,d,f,h,p,_,b=this;return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=r.toLowerCase(),r=r.replace(/^\.+/,"").replace(/\.+$/,""),t.next=4,this.findDeployment(e);case 4:if(n=t.sent){t.next=9;break}throw a=new Error('Deployment not found by "'+e+'". Run '+_chalk2["default"].dim("`now ls`")+" to see your deployments."),a.userError=!0,a;case 9:if(/\./.test(r)?r=(0,_toHost2["default"])(r):(this._debug&&console.log("> [debug] suffixing `.now.sh` to alias "+r),r+=".now.sh"),domainRegex.test(r)){t.next=14;break}throw o=new Error('Invalid alias "'+r+'"'),o.userError=!0,o;case 14:if(/\.now\.sh$/.test(r)){t.next=70;break}return console.log("> "+_chalk2["default"].bold(_chalk2["default"].underline(r))+" is a custom domain."),console.log("> Verifying the DNS settings for "+_chalk2["default"].bold(_chalk2["default"].underline(r))+" (see "+_chalk2["default"].underline("https://zeit.world")+" for help)"),t.prev=17,t.next=20,this.verifyOwnership(r);case 20:t.next=69;break;case 22:if(t.prev=22,t.t0=t["catch"](17),!t.t0.userError){t.next=68;break}return t.prev=25,t.next=28,this.getNameservers(r);case 28:if(s=t.sent,u=s.domain,i=s.nameservers,this._debug&&console.log("> [debug] Found domain "+u+" and nameservers "+i),!(0,_isZeitWorld2["default"])(i)){t.next=56;break}if(console.log("> Detected "+_chalk2["default"].bold(_chalk2["default"].underline("zeit.world"))+" nameservers! Configuring records."),l=r.substr(0,r.length-u.length),c=l.replace(/^\./,"").replace(/\.$/,""),d=u.replace(/^\./,"").replace(/\.$/,""),""!==c){t.next=40;break}return t.next=40,this.setupRecord(d,"*");case 40:return t.next=42,this.setupRecord(d,c);case 42:return this.recordSetup=!0,console.log("> DNS Configured! Verifying propagationâ€¦"),t.prev=44,t.next=47,this.retry(function(){return b.verifyOwnership(r)},{retries:10,maxTimeout:8e3});case 47:t.next=54;break;case 49:throw t.prev=49,t.t1=t["catch"](44),f=new Error("> We configured the DNS settings for your alias, but we were unable to verify that they've propagated. Please try the alias again later."),f.userError=!0,f;case 54:t.next=59;break;case 56:throw console.log("> Resolved IP: "+(t.t0.ip?_chalk2["default"].underline(t.t0.ip)+" (unknown)":_chalk2["default"].dim("none"))),console.log("> Nameservers: "+(i&&i.length?i.map(function(e){return _chalk2["default"].underline(e)}).join(", "):_chalk2["default"].dim("none"))),t.t0;case 59:t.next=66;break;case 61:if(t.prev=61,t.t2=t["catch"](25),!t.t2.userError){t.next=65;break}throw t.t2;case 65:throw t.t0;case 66:t.next=69;break;case 68:throw t.t0;case 69:console.log("> Verification "+_chalk2["default"].bold("OK")+"!");case 70:return t.next=72,this.createAlias(n,r);case 72:h=t.sent,p=h.created,_=h.uid,p?console.log(_chalk2["default"].cyan("> Success!")+" Alias created "+_chalk2["default"].dim("("+_+")")+": "+_chalk2["default"].bold(_chalk2["default"].underline("https://"+r))+" now points to "+_chalk2["default"].bold("https://"+n.url)+" "+_chalk2["default"].dim("("+n.uid+")")):console.log(_chalk2["default"].cyan("> Success!")+" Alias already exists "+_chalk2["default"].dim("("+_+")")+".");case 76:case"end":return t.stop()}},t,this,[[17,22],[25,61],[44,49]])}));return e}()},{key:"createAlias",value:function(e,r){var t=this;return this.retry(function(){var n=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function a(n,o){var s,u,i,l,c,d;return _regenerator2["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return t._debug&&console.time("> [debug] /now/deployments/"+e.uid+"/aliases #"+o),a.next=3,t._fetch("/now/deployments/"+e.uid+"/aliases",{method:"POST",body:{alias:r}});case 3:return s=a.sent,a.next=6,s.json();case 6:if(u=a.sent,t._debug&&console.timeEnd("> [debug] /now/deployments/"+e.uid+"/aliases #"+o),409!==s.status){a.next=10;break}return a.abrupt("return",{uid:u.error.uid});case 10:if(403!==s.status){a.next=21;break}if(i=u.error.code,"custom_domain_needs_upgrade"!==i){a.next=16;break}return l=new Error("Custom domains are only enabled for premium accounts. Please upgrade at "+_chalk2["default"].underline("https://zeit.co/account")+"."),l.userError=!0,a.abrupt("return",n(l));case 16:if("alias_in_use"!==i){a.next=20;break}return c=new Error("The alias you are trying to configure ("+_chalk2["default"].underline(_chalk2["default"].bold(r))+") is already in use by a different account."),c.userError=!0,a.abrupt("return",n(c));case 20:return a.abrupt("return",n(new Error("Authorization error")));case 21:if(!u.error){a.next=37;break}if(d=u.error.code,"deployment_not_found"!==d){a.next=25;break}return a.abrupt("return",n(new Error("Deployment not found")));case 25:if("cert_missing"!==d){a.next=36;break}return console.log("> Provisioning certificate for "+_chalk2["default"].underline(_chalk2["default"].bold(r))),a.prev=27,a.next=30,t.createCert(r);case 30:a.next=35;break;case 32:return a.prev=32,a.t0=a["catch"](27),a.abrupt("return",n(a.t0));case 35:return a.abrupt("return",t.createAlias(e,r));case 36:return a.abrupt("return",n(new Error(u.error.message)));case 37:if(200===s.status||304===s.status){a.next=39;break}throw new Error("Unhandled error");case 39:return a.abrupt("return",u);case 40:case"end":return a.stop()}},a,t,[[27,32]])}));return function(e,r){return n.apply(this,arguments)}}())}},{key:"setupRecord",value:function(){function e(e,t){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e,r){var n,a=this;return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.setupDomain(e);case 2:return this._debug&&console.log('> [debug] Setting up record "'+r+'" for "'+e+'"'),n=""===r?"ALIAS":"CNAME",t.abrupt("return",this.retry(function(){var t=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function o(t,s){var u,i;return _regenerator2["default"].wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return a._debug&&console.time("> [debug] /domains/"+e+"/records #"+s),o.next=3,a._fetch("/domains/"+e+"/records",{method:"POST",body:{type:n,name:""===r?r:"*",value:"alias.zeit.co"}});case 3:if(u=o.sent,a._debug&&console.timeEnd("> [debug] /domains/"+e+"/records #"+s),403!==u.status){o.next=7;break}return o.abrupt("return",t(new Error("Unauthorized")));case 7:return o.next=9,u.json();case 9:if(i=o.sent,200===u.status){o.next=12;break}throw new Error(i.error.message);case 12:return o.abrupt("return",i);case 13:case"end":return o.stop()}},o,a)}));return function(e,r){return t.apply(this,arguments)}}()));case 5:case"end":return t.stop()}},t,this)}));return e}()},{key:"verifyOwnership",value:function(e){var r=this;return this.retry(function(){var t=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function n(t,a){var o,s,u,i,l,c,d,f,h,p;return _regenerator2["default"].wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,(0,_dns.resolve4)("alias.zeit.co");case 2:if(o=n.sent,o.length){n.next=5;break}return n.abrupt("return",t(new Error("Unable to resolve alias.zeit.co")));case 5:return s=[],n.prev=6,n.next=9,(0,_dns.resolve4)(e);case 9:s=n.sent,n.next=19;break;case 12:if(n.prev=12,n.t0=n["catch"](6),"ENODATA"!==n.t0.code&&"ENOTFOUND"!==n.t0.code){n.next=18;break}r._debug&&console.log('> [debug] No records found for "'+e+'"'),n.next=19;break;case 18:throw n.t0;case 19:if(s.length){n.next=23;break}return u=new Error(_errors.DOMAIN_VERIFICATION_ERROR),u.userError=!0,n.abrupt("return",t(u));case 23:i=!0,l=!1,c=void 0,n.prev=26,d=(0,_getIterator3["default"])(s);case 28:if(i=(f=d.next()).done){n.next=38;break}if(h=f.value,~o.indexOf(h)){n.next=35;break}return p=new Error("The domain "+e+" has an A record "+_chalk2["default"].bold(h)+" that doesn't resolve to "+_chalk2["default"].bold(_chalk2["default"].underline("alias.zeit.co"))+".\n> "+_errors.DOMAIN_VERIFICATION_ERROR),p.ip=h,p.userError=!0,n.abrupt("return",t(p));case 35:i=!0,n.next=28;break;case 38:n.next=44;break;case 40:n.prev=40,n.t1=n["catch"](26),l=!0,c=n.t1;case 44:n.prev=44,n.prev=45,!i&&d["return"]&&d["return"]();case 47:if(n.prev=47,!l){n.next=50;break}throw c;case 50:return n.finish(47);case 51:return n.finish(44);case 52:case"end":return n.stop()}},n,r,[[6,12],[26,40,44,52],[45,,47,51]])}));return function(e,r){return t.apply(this,arguments)}}())}},{key:"createCert",value:function(e){var r=this;return this.retry(function(){var t=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function n(t,a){var o,s,u,i,l;return _regenerator2["default"].wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return r._debug&&console.time("> [debug] /now/certs #"+a),n.next=3,r._fetch("/now/certs",{method:"POST",body:{domains:[e]}});case 3:if(o=n.sent,304!==o.status){n.next=7;break}return console.log("> Certificate already issued."),n.abrupt("return");case 7:return n.next=9,o.json();case 9:if(s=n.sent,r._debug&&console.timeEnd("> [debug] /now/certs #"+a),!s.error){n.next=24;break}if(u=s.error.code,"verification_failed"!==u){n.next=19;break}throw i=new Error("The certificate issuer failed to verify ownership of the domain. This likely has to do with DNS propagation and caching issues. Please retry later!"),i.userError=!0,i;case 19:if("rate_limited"!==u){n.next=23;break}return l=new Error(s.error.message),l.userError=!0,n.abrupt("return",t(l));case 23:throw new Error(s.message);case 24:if(200===o.status||304===o.status){n.next=26;break}throw new Error("Unhandled error");case 26:case"end":return n.stop()}},n,r)}));return function(e,r){return t.apply(this,arguments)}}(),{retries:5,minTimeout:3e4,maxTimeout:9e4})}}]),r}(_2["default"]);exports["default"]=Alias;